Bootstrap: docker
From: node:18-alpine

%files
    ./environment.sh /environment.sh
    ./include/* /include/

%appinstall compute
    SOURCE_ENV=". /environment.sh"
    eval ${SOURCE_ENV}
    echo ${SOURCE_ENV} >>${APPTAINER_ENVIRONMENT}
    cp /include/* ${XDG_CONFIG_HOME}/compute/include
    apk update
    apk add apptainer
    apk add shadow-uidmap
    apk add shadow
    apk add libcap
    su -
    chmod u+s /usr/bin/newuidmap
    chmod u+s /usr/bin/newgidmap
    setcap cap_setgid+eip /usr/bin/newgidmap
    setcap cap_setuid+eip /usr/bin/newuidmap
    ls -l /usr/bin/newuidmap /usr/bin/newgidmap
    getcap /usr/bin/newuidmap /usr/bin/newgidmap
    echo "root:100000:65536" >> /etc/subuid
    echo "root:100000:65536" >> /etc/subgid
    apptainer build -F --fakeroot ${XDG_DATA_HOME}/compute/app.sif ${XDG_CONFIG_HOME}/compute/include/app.def

%apprun compute
    apptainer run --app app --containall ${XDG_DATA_HOME}/compute/app.sif

%labels
    Author 1nf053c
    Version 1.0
    Description "Container for compute"
