Bootstrap: docker
From: node:18-alpine

%files
    ./environment.sh /environment.sh
    ./include/* /include/

%appinstall compute
    SOURCE_ENV="source /environment.sh"
    eval ${SOURCE_ENV}
    echo ${SOURCE_ENV} >>${APPTAINER_ENVIRONMENT}

    cp /include/* ${XDG_CONFIG_HOME}/compute/include

    apk update
    apk add --no-cache \
    build-base \
    linux-headers \
    libseccomp-dev \
    glib-dev \
    cryptsetup-dev \
    squashfs-tools \
    fakeroot \
    git \
    bash

    wget https://golang.org/dl/go1.20.6.linux-amd64.tar.gz
    tar -C /usr/local -xzf go1.20.6.linux-amd64.tar.gz

    ADD_GO_TO_PATH_VAR="export PATH=$PATH:/usr/local/go/bin"
    eval ${ADD_GO_TO_PATH_VAR}
    echo ${ADD_GO_TO_PATH_VAR} >>${APPTAINER_ENVIRONMENT}
    go version ## ERROR?

    APPTAINER_DIR="$XDG_DATA_HOME/apptainer"
    mkdir -p "$APPTAINER_DIR"
    cd $APPTAINER_DIR

    git clone --no-checkout https://github.com/apptainer/apptainer.git .
    git checkout

    ./mconfig -v -p $APPTAINER_DIR
    make -C ./builddir all
    make -C ./builddir install
    export PATH="$PATH:$APPTAINER_DIR/bin"

    apptainer build -F --fakeroot ${XDG_DATA_HOME}/compute/app.sif ${XDG_CONFIG_HOME}/compute/include/app.def

%apprun compute
    apptainer run --app app --containall ${XDG_DATA_HOME}/compute/app.sif

%labels
    Author 1nf053c
    Version 1.0
    Description "Container for compute"
