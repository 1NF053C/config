Bootstrap: docker
From: node:18-alpine

%files
    * /app

%setup
    # Ensure shadow and libcap are installed
    apk add shadow libcap

    # Set setuid root for newuidmap and newgidmap
    chmod u+s /usr/bin/newuidmap
    chmod u+s /usr/bin/newgidmap

    # Set capabilities
    setcap cap_setuid+eip /usr/bin/newuidmap
    setcap cap_setgid+eip /usr/bin/newgidmap

    echo "root:100000:65536" >> /etc/subuid
    echo "root:100000:65536" >> /etc/subgid

%appinstall app
    apk add --no-cache sqlite
    apk add --no-cache nodejs npm

    cp /app/* ${XDG_CONFIG_HOME}/app/
    cd ${XDG_CONFIG_HOME}/app/

    npm init -y
    npm install --save-dev typescript ts-node @types/node @faker-js/faker @types/node tsx
    npm install @prisma/client prisma ts-patch ts-runtime-checks
    npx ts-patch install

    mkdir -p prisma/
    mv schema.prisma /prisma/schema.prisma

    npx prisma init
    rm -rf ./prisma/migrations
    npx prisma migrate reset -f
    npx prisma generate
    npx prisma migrate dev --name init

    tsc seedDb.ts

%apprun app
    cd ${XDG_CONFIG_HOME}/app
    node ./seedDb.js

%labels
    Author 1nf053c
    Version 1.0
    Description "Container for compute"
